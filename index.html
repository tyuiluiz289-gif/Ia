<!-- Loader: tenta ESM (esm.run) -> UMD (jsDelivr/unpkg) -> arquivo local -->
<script>
  (function () {
    const ESM_SOURCES = [
      "https://esm.run/@mlc-ai/web-llm@0.2.65"
    ];
    // UMD expõe window.webllm
    const UMD_SOURCES = [
      "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.65/dist/index.js",
      "https://unpkg.com/@mlc-ai/web-llm@0.2.65/dist/index.js"
    ];
    const UMD_LOCAL = "./web-llm.js"; // opcional (se você enviar o arquivo junto)
    const TIMEOUT_MS = 12000;

    const emit = (msg) => window.dispatchEvent(new CustomEvent("ava:status", { detail: msg }));

    function importWithTimeout(url, ms) {
      return Promise.race([
        import(/* @vite-ignore */ (url + (url.includes("?") ? "&" : "?") + "v=2")),
        new Promise((_, rej) => setTimeout(() => rej(new Error("timeout")), ms))
      ]);
    }

    function loadScript(url, ms) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        const t = setTimeout(() => { s.remove(); reject(new Error("timeout")); }, ms);
        s.src = url + (url.includes("?") ? "&" : "?") + "v=2";
        s.async = true;
        s.crossOrigin = "anonymous";
        s.onload = () => { clearTimeout(t); resolve(); };
        s.onerror = () => { clearTimeout(t); reject(new Error("erro script "+url)); };
        document.head.appendChild(s);
      });
    }

    async function ensureWebLLM() {
      if (globalThis.webllm && (webllm.CreateMLCEngine || webllm.CreateWebWorkerMLCEngine)) return true;

      emit("Carregando runtime da IA… primeira inicialização pode demorar.");

      // 1) Tenta ESM
      for (const url of ESM_SOURCES) {
        try {
          const mod = await importWithTimeout(url, TIMEOUT_MS);
          globalThis.webllm = mod;
          if (webllm.CreateMLCEngine || webllm.CreateWebWorkerMLCEngine) {
            emit("WebLLM carregado via ESM.");
            return true;
          }
        } catch (e) {
          console.warn("[WebLLM/ESM] falhou:", url, e?.message || e);
          emit("ESM falhou/lento, tentando UMD…");
        }
      }

      // 2) Tenta UMD (CDNs)
      for (const url of UMD_SOURCES) {
        try {
          await loadScript(url, TIMEOUT_MS);
          if (globalThis.webllm && (webllm.CreateMLCEngine || webllm.CreateWebWorkerMLCEngine)) {
            emit("WebLLM carregado via UMD.");
            return true;
          }
        } catch (e) {
          console.warn("[WebLLM/UMD] falhou:", url, e?.message || e);
        }
      }

      // 3) Último recurso: arquivo local
      try {
        await loadScript(UMD_LOCAL, TIMEOUT_MS);
        if (globalThis.webllm && (webllm.CreateMLCEngine || webllm.CreateWebWorkerMLCEngine)) {
          emit("WebLLM carregado via arquivo local.");
          return true;
        }
      } catch (e) {
        console.warn("[WebLLM/local] falhou:", e?.message || e);
      }

      emit("Falha ao iniciar a IA: não consegui carregar o WebLLM (ESM/UMD/local).");
      return false;
    }

    ensureWebLLM();
  })();
</script>
