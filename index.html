<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>AvaGPT - Offline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Manifest + ícone (ARQUIVOS NA MESMA PASTA DO INDEX) -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon-192.png" />

  <!-- WebLLM (runtime no navegador) -->
  <script src="https://unpkg.com/@mlc-ai/web-llm@0.2.65/dist/index.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; max-width: 720px; margin: 0 auto; padding: 16px; background:#0b1220; color:#fff; }
    h1 { margin: 0 0 12px 0; }
    #chat-box { background:#111827; border-radius: 12px; padding: 12px; min-height: 240px; max-height: 60vh; overflow-y:auto; }
    .row { display:flex; gap:8px; margin-top:12px; }
    input { flex:1; padding: 10px; border-radius: 10px; border: 0; background:#0f172a; color:#fff; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor:pointer; background:#1f2937; color:#fff; }
    p { line-height: 1.45; margin: 8px 0; }
    #status { font-size: 14px; opacity:.95; background:#0f172a; border:1px solid #1f2937; padding:8px 10px; border-radius:8px; margin: 10px 0; display:none; }
  </style>
</head>
<body>
  <h1>AvaGPT</h1>

  <div id="status">Preparando a IA…</div>
  <div id="chat-box"></div>

  <div class="row">
    <input id="user-input" placeholder="Fala com a Ava..." autocomplete="off" />
    <button id="send-btn">Enviar</button>
  </div>

  <!-- Núcleo do chat (ARQUIVO NA MESMA PASTA) -->
  <script src="./chat-core.js"></script>
  <script>
    const box = document.getElementById("chat-box");
    const inputEl = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const statusEl = document.getElementById("status");
    let busy = false;

    function showStatus(msg){ statusEl.textContent = msg; statusEl.style.display = 'block'; }
    function hideStatus(){ statusEl.style.display = 'none'; }
    function append(html){ box.insertAdjacentHTML("beforeend", html); box.scrollTop = box.scrollHeight; }

    // Progresso/erros vindos do chat-core (emitido por initProgressCallback e ensureModel)
    window.addEventListener("ava:status", (e) => {
      const d = e?.detail;
      if (!d) return;
      if (typeof d === "string") {
        showStatus(d);
      } else {
        const txt = d.text || "Carregando modelo…";
        const pct = (typeof d.pct === "number") ? ` (${d.pct}%)` : "";
        showStatus(txt + pct);
      }
    });

    // Pré-aquecer o modelo ao abrir a página (começa o download sem esperar a 1ª mensagem)
    window.addEventListener("load", () => {
      if (typeof window.prewarmModel === "function") {
        showStatus("Inicializando IA…");
        window.prewarmModel().catch(err => {
          console.error(err);
          showStatus("Falha ao iniciar a IA: " + (err?.message || err));
        });
      }
    });

    // Aviso se o runtime ainda não foi injetado
    if (!(globalThis.webllm && globalThis.webllm.CreateMLCEngine)) {
      showStatus("WebLLM não carregou ainda. A primeira inicialização pode demorar um pouco na rede móvel.");
    }

    async function handleSend() {
      if (busy) return;
      const text = inputEl.value.trim();
      if (!text) return;

      append(`<p><b>Você:</b> ${text}</p>`);
      inputEl.value = "";
      inputEl.focus();

      const typingId = `ava-typing-${Date.now()}`;
      append(`<p id="${typingId}"><b>Ava:</b> digitando...</p>`);
      busy = true; sendBtn.disabled = true;

      try {
        if (typeof window.sendMessage !== "function") throw new Error("sendMessage não está definida. Verifica ./chat-core.js");
        showStatus("Carregando IA… pode demorar na primeira vez.");
        const reply = await window.sendMessage(text);
        const node = document.getElementById(typingId);
        if (node) node.outerHTML = `<p><b>Ava:</b> ${reply}</p>`;
      } catch (e) {
        console.error(e);
        const node = document.getElementById(typingId);
        if (node) node.outerHTML = `<p><b>Ava:</b> erro ao responder. Confere o WebLLM e o ./chat-core.js.</p>`;
      } finally {
        hideStatus(); busy = false; sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener("click", handleSend);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Enter") handleSend(); });
  </script>

  <!-- Service Worker (ARQUIVO NA MESMA PASTA) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(r => console.log('SW registrado:', r.scope))
          .catch(e => console.error('SW erro:', e));
      });
    }
  </script>
</body>
</html>
